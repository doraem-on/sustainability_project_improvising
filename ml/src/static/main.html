<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarSense AI - Digital Twin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #0d6efd;       
            --dark-blue: #1e3c72;     
            --light-blue: #2a5298;    
            --accent: #ffc107;        
            --success: #198754;       
            --bg-color: #f4f6f9;      
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden; /* Prevent scrollbar from 3D canvas */
        }

        /* NEW: DRAMATIC BACKGROUND CANVAS */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; 
            /* Gradient overlay to make text readable */
            background: radial-gradient(circle at center, transparent 0%, #f4f6f9 90%);
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, rgba(30, 60, 114, 0.95) 0%, rgba(42, 82, 152, 0.95) 100%);
            padding: 3rem 0;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .hero-icon { font-size: 3.5rem; margin-bottom: 0.5rem; color: var(--accent); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        /* Cards */
        .card {
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.05);
            background: rgba(255, 255, 255, 0.9); /* More transparency for background visibility */
            margin-bottom: 24px;
            overflow: hidden;
            transition: transform 0.2s;
            backdrop-filter: blur(10px); /* Glassmorphism */
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        
        /* Card Headers */
        .card-header-custom {
            background: white;
            color: var(--dark-blue);
            padding: 1rem 1.5rem;
            font-weight: 700;
            border-bottom: 2px solid #f0f0f0;
            display: flex; align-items: center; gap: 10px;
        }
        .card-header-custom i { color: var(--primary); font-size: 1.1rem; }

        /* 3D Canvas (Solar Panel) */
        #canvas-container {
            width: 100%; height: 350px;
            background: linear-gradient(to bottom, #eef2f3, #dfe9f3);
            border-bottom: 1px solid #ddd;
        }

        #map { height: 400px; width: 100%; z-index: 1; }

        .form-label { font-size: 0.9rem; font-weight: 600; color: #555; margin-bottom: 0.4rem; }
        .form-control, .form-range { border-radius: 8px; border: 1px solid #ced4da; padding: 0.6rem; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15); }

        .btn-predict {
            background: var(--dark-blue); color: white;
            border: none; border-radius: 8px; padding: 0.8rem; font-weight: 600; width: 100%;
            transition: all 0.2s;
        }
        .btn-predict:hover { background: var(--light-blue); box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3); }

        .btn-weather {
            background: white; color: var(--primary); border: 2px solid var(--primary);
            border-radius: 8px; font-weight: 600; width: 100%; margin-bottom: 1rem; padding: 0.6rem;
        }
        .btn-weather:hover { background: var(--primary); color: white; }

        .roi-container { background: #fff; border-top: 1px solid #eee; padding: 1.5rem; }
        .roi-value { color: var(--success); font-weight: 800; font-size: 1.5rem; }

        .metric-card {
            background: white; border-radius: 12px; padding: 1.5rem; text-align: center;
            border: 1px solid #eee; height: 100%; position: relative; overflow: hidden;
        }
        .metric-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
        .metric-value { font-size: 2.5rem; font-weight: 700; color: #333; margin: 0.5rem 0; }
        
        .status-badge { display: inline-block; padding: 0.4rem 1rem; border-radius: 50px; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.5px; }
        .status-success { background: #d1e7dd; color: #0f5132; }
        .status-warning { background: #fff3cd; color: #664d03; }
        .status-danger { background: #f8d7da; color: #842029; }

        .insights-box { background: #eef2f5; border-radius: 10px; padding: 1.5rem; border-left: 4px solid var(--dark-blue); }
        .insight-line { margin-bottom: 0.8rem; display: flex; align-items: start; gap: 12px; font-size: 0.95rem; }

        .shap-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .shap-pos { color: var(--success); font-weight: bold; }
        .shap-neg { color: #dc3545; font-weight: bold; }

        /* NEW: ENTERPRISE OVERLAY STYLES */
        #enterprise-monitor {
            position: absolute; top: 10px; right: 10px; width: 240px;
            background: rgba(13, 110, 253, 0.9); color: white;
            padding: 15px; border-radius: 10px; z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 0.85rem; backdrop-filter: blur(5px);
        }
        .health-bar-bg { background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; margin: 10px 0; }
        #health-bar-fill { background: #4CAF50; width: 100%; height: 100%; border-radius: 4px; transition: 0.5s; }
    </style>
</head>
<body>

    <div id="bg-canvas"></div>

    <div class="hero text-center">
        <div class="container">
            <div class="hero-icon"><i class="fas fa-solar-panel"></i></div>
            <h1 class="fw-bold">SolarSense AI</h1>
            <p class="opacity-75 mb-0" style="font-size: 1.1rem; letter-spacing: 0.5px;">Intelligent Digital Twin & Site Assessment</p>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card h-100">
                    <div class="card-header-custom">
                        <i class="fas fa-sliders-h"></i> Live Conditions
                    </div>
                    <div class="card-body p-4">
                        <button type="button" class="btn btn-weather" onclick="fetchLocalWeather()">
                            <i class="fas fa-location-arrow me-2"></i> Locate Me
                        </button>

                        <form id="predictForm">
                            <div class="mb-3">
                                <label class="form-label">Temperature (Â°C)</label>
                                <input type="number" id="temperature" value="35.0" step="any" class="form-control">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Humidity (%)</label>
                                <input type="number" id="humidity" value="65.0" step="any" class="form-control">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Irradiance (W/mÂ²)</label>
                                <input type="number" id="irradiance" value="850" step="any" class="form-control" oninput="update3DFromSliders()">
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label d-flex justify-content-between">
                                    Dust Index <span class="text-muted small fw-normal">(0=Clean, 1=Dirty)</span>
                                </label>
                                <input type="range" id="dust_index" value="0.2" min="0" max="1" step="0.01" class="form-range" oninput="update3DFromSliders()">
                            </div>
                            
                            <div class="p-3 bg-light rounded border mb-4">
                                <label class="form-label d-flex justify-content-between mb-2">
                                    <span><i class="fas fa-clock text-muted"></i> Time of Day</span>
                                    <span id="timeDisplay" class="badge bg-secondary">12:00 PM</span>
                                </label>
                                <input type="range" id="timeSlider" class="form-range" min="6" max="18" step="0.1" value="12" oninput="updateSunPosition()">
                                
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="autoTiltToggle" onchange="toggleAutoTilt()">
                                    <label class="form-check-label small" for="autoTiltToggle">Auto-Rotate (Dual-Axis Tracker)</label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-predict">
                                <i class="fas fa-bolt me-2"></i> Run Analysis
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card h-100 border-0 position-relative">
                    <div class="card-header-custom">
                        <i class="fas fa-cube"></i> 3D Digital Twin
                    </div>

                    <div id="enterprise-monitor">
                        <div class="d-flex justify-content-between">
                            <strong>Health Index</strong>
                            <span id="health-pct">100%</span>
                        </div>
                        <div class="health-bar-bg"><div id="health-bar-fill"></div></div>
                        <div class="mt-2 small">
                            <strong>Status:</strong> <span id="telemetry-status" style="color: #4CAF50; font-weight: bold;">Operational</span><br>
                            <strong>Diagnosis:</strong> <span id="telemetry-diag">Normal</span>
                        </div>
                        <button onclick="triggerSimulation()" class="btn btn-sm btn-light w-100 mt-2 fw-bold text-primary">ðŸ“¡ Simulate Live Feed</button>
                    </div>

                    <div class="card-body p-0 d-flex flex-column">
                        <div id="canvas-container" style="flex-grow: 1;"></div> 
                        
                        <div class="roi-container">
                            <div class="row text-center">
                                <div class="col-6 border-end">
                                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Daily Generation</small>
                                    <h3 id="daily-gen" class="text-dark mt-1">0 kWh</h3>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Est. Value</small>
                                    <h3 id="daily-savings" class="roi-value mt-1">$0.00</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header-custom">
                        <i class="fas fa-globe-americas"></i> Global Site Selector
                    </div>
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsSection" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                    <div class="metric-card">
                        <div class="text-muted small text-uppercase fw-bold mb-2">Efficiency Prediction</div>
                        <div class="metric-value" id="efficiencyValue">--%</div>
                        <div id="efficiencyBadge"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="metric-card" style="border-left-color: #dc3545;">
                        <div class="text-muted small text-uppercase fw-bold mb-2">Risk Factor</div>
                        <div class="metric-value" id="riskValue">--%</div>
                        <div id="riskBadge"></div>
                    </div>
                </div>
            </div>

            <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center gap-3" role="alert">
                <i class="fas fa-exclamation-circle fa-2x"></i>
                <div>
                    <h5 class="alert-heading mb-1" style="font-size: 1rem; font-weight: 700;">Recommended Action</h5>
                    <p class="mb-0 small" id="actionText">Waiting for data...</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header-custom">
                    <i class="fas fa-file-alt"></i> AI Insights
                </div>
                <div class="card-body">
                    <div id="suitabilityBadge" class="mb-3 text-center"></div>
                    <div class="insights-box">
                        <div id="insightsText"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header-custom">
                            <i class="fas fa-microchip"></i> Feature Impact (SHAP)
                        </div>
                        <div class="card-body">
                            <div id="shapExplanation"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header-custom">
                            <i class="fas fa-chart-pie"></i> Efficiency Breakdown
                        </div>
                        <div class="card-body text-center d-flex justify-content-center align-items-center">
                            <div style="width: 250px;">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center py-4 text-muted small">
            &copy; 2024 SolarSense AI Project
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let scene, camera, renderer, panel, sunLight, ambientLight;
        let isAutoTilt = false;
        let map, marker; 

        // --- 1. INITIALIZE ---
        window.onload = function() {
            init3D();
            initDramaticBackground(); 
            initMap(); 
            
            const now = new Date();
            const currentHour = now.getHours() + (now.getMinutes() / 60);
            if (currentHour >= 6 && currentHour <= 18) {
                document.getElementById('timeSlider').value = currentHour;
            }
            updateSunPosition();
            update3DFromSliders();
        };

        // --- NEW: TELEMETRY SIMULATION LOGIC ---
        async function triggerSimulation() {
            try {
                // 1. Fetch a random reading from the processed training data
                const simRes = await fetch('/api/simulation/next_reading');
                const simData = await simRes.json();
                
                if (simData.status === 'error') throw new Error(simData.message);

                // 2. Send to Digital Twin for analysis
                const analysisRes = await fetch('/api/analyze_telemetry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(simData)
                });
                const result = await analysisRes.json();

                // 3. Update the Enterprise Overlay UI
                const health = result.digital_twin_analysis.health_index;
                const statusEl = document.getElementById('telemetry-status');
                const barFill = document.getElementById('health-bar-fill');

                document.getElementById('health-pct').innerText = health + "%";
                barFill.style.width = health + "%";
                document.getElementById('telemetry-diag').innerText = result.diagnosis.condition;

                if (health < 75) {
                    statusEl.innerText = "MAINTENANCE REQ";
                    statusEl.style.color = "#f44336";
                    barFill.style.backgroundColor = "#f44336";
                } else {
                    statusEl.innerText = "OPERATIONAL";
                    statusEl.style.color = "#4CAF50";
                    barFill.style.backgroundColor = "#4CAF50";
                }

                // 4. Trigger 3D Glow (Grounded in legacy logic)
                updateColorByEfficiency(health / 100);

            } catch (err) {
                console.error("Simulation failed:", err);
                alert("Simulation Error: " + err.message);
            }
        }

        // --- DRAMATIC INTERACTIVE BACKGROUND (Preserved) ---
        function initDramaticBackground() {
            const container = document.getElementById('bg-canvas');
            const bgScene = new THREE.Scene();
            
            const bgCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            bgCamera.position.z = 100;

            const bgRenderer = new THREE.WebGLRenderer({ alpha: true });
            bgRenderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(bgRenderer.domElement);

            const particlesCount = 200; 
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            
            for (let i = 0; i < particlesCount; i++) {
                const x = (Math.random() - 0.5) * 400;
                const y = (Math.random() - 0.5) * 400;
                const z = (Math.random() - 0.5) * 200;
                positions.push(x, y, z);
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({
                color: 0x0d6efd, 
                size: 2,
                transparent: true,
                opacity: 0.8
            });

            const particles = new THREE.Points(geometry, material);
            bgScene.add(particles);

            let mouseX = 0; let mouseY = 0;
            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX - windowHalfX);
                mouseY = (event.clientY - windowHalfY);
            });

            const animateBg = () => {
                requestAnimationFrame(animateBg);
                particles.rotation.y += 0.005 * ((mouseX * 0.001) - particles.rotation.y);
                particles.rotation.x += 0.005 * ((mouseY * 0.001) - particles.rotation.x);
                particles.rotation.z += 0.002; 
                bgRenderer.render(bgScene, bgCamera);
            };
            animateBg();

            window.addEventListener('resize', () => {
                bgCamera.aspect = window.innerWidth / window.innerHeight;
                bgCamera.updateProjectionMatrix();
                bgRenderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- MAP LOGIC (Preserved) ---
        function initMap() {
            map = L.map('map').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.on('click', function(e) {
                if (marker) marker.setLatLng(e.latlng);
                else marker = L.marker(e.latlng).addTo(map);
                fetchWeatherData(e.latlng.lat, e.latlng.lng);
            });
        }

        async function fetchWeatherData(lat, lon) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,direct_radiation`;
                const res = await fetch(url);
                const data = await res.json();
                document.getElementById('temperature').value = data.current.temperature_2m;
                document.getElementById('humidity').value = data.current.relative_humidity_2m;
                document.getElementById('irradiance').value = data.current.direct_radiation || 800; 
                update3DFromSliders();
            } catch (e) { alert("Could not fetch weather data."); }
        }

        // --- SOLAR PANEL 3D SCENE (Preserved) ---
        function init3D() {
            const container = document.getElementById('canvas-container');
            if (!container) return;
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeef2f3); 
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 3, 6); 
            camera.lookAt(0, 0, 0);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            const groundGeo = new THREE.PlaneGeometry(20, 20);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2; ground.position.y = -1.5;
            ground.receiveShadow = true; scene.add(ground);
            panel = new THREE.Mesh(new THREE.BoxGeometry(3, 0.1, 2), new THREE.MeshStandardMaterial({ color: 0x0d6efd, roughness: 0.2, metalness: 0.5 }));
            panel.castShadow = true; scene.add(panel);
            const stand = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1.5, 32), new THREE.MeshStandardMaterial({ color: 0x6c757d }));
            stand.position.y = -0.75; scene.add(stand);
            sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(5, 10, 5); sunLight.castShadow = true; scene.add(sunLight);
            ambientLight = new THREE.AmbientLight(0x404040); scene.add(ambientLight);
            animate();
        }

        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

        function updateSunPosition() {
            const slider = document.getElementById('timeSlider');
            if(!slider) return;
            const hour = parseFloat(slider.value);
            const h = Math.floor(hour); const m = Math.floor((hour - h) * 60);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const fmtHour = h > 12 && h !== 12 ? h - 12 : (h === 0 || h === 24 ? 12 : h);
            document.getElementById('timeDisplay').innerText = `${fmtHour}:${m.toString().padStart(2, '0')} ${ampm}`;
            const angle = (hour - 12) * (Math.PI / 12); 
            sunLight.position.x = Math.sin(angle) * 8; sunLight.position.y = Math.cos(angle) * 8;
            if (hour < 6.5 || hour > 17.5) { ambientLight.intensity = 0.2; sunLight.intensity = 0.2; }
            else { ambientLight.intensity = 0.5; sunLight.intensity = 1.2; }
            if (isAutoTilt && panel) panel.rotation.z = -angle;
            else if (panel) panel.rotation.z = 0;
        }

        function toggleAutoTilt() { isAutoTilt = document.getElementById('autoTiltToggle').checked; updateSunPosition(); }

        function update3DFromSliders() {
            if (!panel) return;
            const dustLevel = parseFloat(document.getElementById('dust_index').value);
            panel.material.color.lerpColors(new THREE.Color(0x0d6efd), new THREE.Color(0x8b7355), dustLevel);
        }

        function updateColorByEfficiency(efficiency) {
            if (!panel) return;
            panel.material.emissiveIntensity = 0; panel.material.emissive.setHex(0x000000);
            if (efficiency < 0.70) { panel.material.emissive.setHex(0xdc3545); panel.material.emissiveIntensity = 0.4; }
            else if (efficiency > 0.85) { panel.material.emissive.setHex(0x198754); panel.material.emissiveIntensity = 0.3; }
        }

        // --- APP LOGIC (Preserved) ---
        function fetchLocalWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude; const lon = position.coords.longitude;
                    if(map) { map.setView([lat, lon], 10); if(marker) marker.setLatLng([lat, lon]); else marker = L.marker([lat, lon]).addTo(map); }
                    fetchWeatherData(lat, lon);
                });
            } else { alert("Geolocation not allowed."); }
        }

        function updateROI(efficiency) {
            const kwh = 5 * 5 * efficiency; 
            document.getElementById('daily-gen').innerText = kwh.toFixed(1) + " kWh";
            document.getElementById('daily-savings').innerText = "$" + (kwh * 0.12).toFixed(2);
        }

        document.getElementById('predictForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                temperature: parseFloat(document.getElementById('temperature').value),
                humidity: parseFloat(document.getElementById('humidity').value),
                irradiance: parseFloat(document.getElementById('irradiance').value),
                dust_index: parseFloat(document.getElementById('dust_index').value)
            };
            try {
                const res = await fetch('http://localhost:5001/predict', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                const result = await res.json();
                document.getElementById('resultsSection').style.display = 'block';
                displayResults(result); updateROI(result.predicted_efficiency); updateColorByEfficiency(result.predicted_efficiency);
            } catch (err) { alert("Server error. Check Flask console."); }
        });

        function displayResults(result) {
            const eff = (result.predicted_efficiency * 100).toFixed(1);
            document.getElementById('efficiencyValue').innerText = eff + "%";
            document.getElementById('efficiencyBadge').innerHTML = result.predicted_efficiency > 0.75 ? '<span class="status-badge status-success">OPTIMAL</span>' : '<span class="status-badge status-danger">ATTENTION</span>';
            document.getElementById('riskValue').innerText = result.risk_score + "%";
            document.getElementById('riskBadge').innerHTML = result.risk_score < 50 ? '<span class="status-badge status-success">LOW RISK</span>' : '<span class="status-badge status-warning">HIGH RISK</span>';
            document.getElementById('actionText').innerText = result.recommended_action;
            document.getElementById('suitabilityBadge').innerHTML = result.suitability === 'Yes' ? '<span class="status-badge status-success fs-6">Site Suitable</span>' : '<span class="status-badge status-danger fs-6">Not Suitable</span>';
            const insightsContainer = document.getElementById('insightsText');
            insightsContainer.innerHTML = result.insights_and_suggestions.split('\n').map(l => l.trim().length > 0 ? `<div class="insight-line"><i class="fas fa-chevron-right text-primary"></i> ${l}</div>` : '').join('');
            const shapDiv = document.getElementById('shapExplanation');
            shapDiv.innerHTML = Object.entries(result.explanation).sort((a,b) => Math.abs(b[1]) - Math.abs(a[1])).slice(0,5).map(([k, v]) => `
                <div class="shap-row">
                    <span class="text-capitalize">${k.replace('_', ' ')}</span>
                    <span class="${v > 0 ? 'shap-pos' : 'shap-neg'}">${v > 0 ? '+' : ''}${v.toFixed(4)}</span>
                </div>`).join('');
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            if(window.effChart) window.effChart.destroy();
            window.effChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Active', 'Loss'], datasets: [{ data: [result.predicted_efficiency*100, 100-(result.predicted_efficiency*100)], backgroundColor: ['#198754', '#dc3545'], borderWidth: 0 }] } });
        }
    </script>
</body>
</html>